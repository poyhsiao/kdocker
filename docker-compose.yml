version: "2.4"
services:
  applications:
    image: tianon/true
    volumes:
      - "${LOCAL_PATH1:-../web/pt1}:/var/www${POINTER1:-pt1}"
      - "${LOCAL_PATH2:-../web/pt2}:/var/www${POINTER2:-pt2}"
      - "${LOCAL_PATH3:-../web/pt3}:/var/www${POINTER3:-pt3}"
      - "${APP_PATH:-../web/app}:${APP_POINTER:-/usr/src/app}"

  workspace:
    build:
      context: ./workspace
      args:
        - "PHP_VERSION=${PHP_VERSION:-7.2}"
        - "NPROC=${NPROC:-1}"
        - "TZ=${TIMEZONE:-UTC}"
        - "PUID=${PUID:-1000}"
        - "PGID=${PGID:-1000}"
        - "LINUX_USER=${LINUX_USER:-kimhsiao}"
        - "CANVAS_SUPPORT=${WORKSPACE_CANVAS_SUPPORT:-false}"
        - "INSTALL_MCRYPT=${PHP_FPM_INSTALL_MCRYPT:-false}"
        - "INSTALL_PDO_MYSQL=${PHP_FPM_INSTALL_PDO_MYSQL:-false}"
        - "INSTALL_PDO_PGSQL=${PHP_FPM_INSTALL_PDO_PGSQL:-false}"
        - "INSTALL_PDO_SQLITE=${PHP_FPM_INSTALL_PDO_SQLITE:-false}"
        - "INSTALL_GD=${PHP_FPM_INSTALL_GD:-false}"
        - "INSTALL_APC=${PHP_FPM_INSTALL_APC:-false}"
        - "INSTALL_FTP=${PHP_FPM_INSTALL_FTP:-false}"
        - "INSTALL_XSL=${PHP_FPM_INSTALL_XSL:-false}"
        - "INSTALL_CALENDAR=${PHP_FPM_INSTALL_CALENDAR:-false}"
        - "INSTALL_CTYPE=${PHP_FPM_INSTALL_CTYPE:-false}"
        - "INSTALL_DBA=${PHP_FPM_INSTALL_DBA:-false}"
        - "INSTALL_DOM=${PHP_FPM_INSTALL_DOM:-false}"
        - "INSTALL_JSON=${PHP_FPM_INSTALL_JSON:-false}"
        - "INSTALL_HASH=${PHP_FPM_INSTALL_HASH:-false}"
        - "INSTALL_SOCKETS=${PHP_FPM_INSTALL_SOCKETS:-false}"
        - "INSTALL_PDO=${PHP_FPM_INSTALL_PDO:-false}"
        - "INSTALL_MBSTRING=${PHP_FPM_INSTALL_MBSTRING:-false}"
        - "INSTALL_IMAP=${PHP_FPM_INSTALL_IMAP:-false}"
        - "INSTALL_CURL=${PHP_FPM_INSTALL_CURL:-false}"
        - "INSTALL_FILEINFO=${PHP_FPM_INSTALL_FILEINFO:-false}"
        - "INSTALL_GETTEXT=${PHP_FPM_INSTALL_GETTEXT:-false}"
        - "INSTALL_ICONV=${PHP_FPM_INSTALL_ICONV:-false}"
        - "INSTALL_PHAR=${PHP_FPM_INSTALL_PHAR:-false}"
        - "INSTALL_POSIX=${PHP_FPM_INSTALL_POSIX:-false}"
        - "INSTALL_PSPELL=${PHP_FPM_INSTALL_PSPELL:-false}"
        - "INSTALL_READLINE=${PHP_FPM_INSTALL_READLINE:-false}"
        - "INSTALL_RECODE=${PHP_FPM_INSTALL_RECODE:-false}"
        - "INSTALL_SHMOP=${PHP_FPM_INSTALL_SHMOP:-false}"
        - "INSTALL_SIMPLEXML=${PHP_FPM_INSTALL_SIMPLEXML:-false}"
        - "INSTALL_SNMP=${PHP_FPM_INSTALL_SNMP:-false}"
        - "INSTALL_SYSVMSG=${PHP_FPM_INSTALL_SYSVMSG:-false}"
        - "INSTALL_SYSVSEM=${PHP_FPM_INSTALL_SYSVSEM:-false}"
        - "INSTALL_SYSVSHM=${PHP_FPM_INSTALL_SYSVSHM:-false}"
        - "INSTALL_BZ2=${PHP_FPM_INSTALL_BZ2:-false}"
        - "INSTALL_ENCHANT=${PHP_FPM_INSTALL_ENCHANT:-false}"
        - "INSTALL_YAML=${PHP_FPM_INSTALL_YAML:-false}"
        - "INSTALL_EVENT=${PHP_FPM_INSTALL_EVENT:-false}"
        - "INSTALL_TIDY=${PHP_FPM_INSTALL_TIDY:-false}"
        - "INSTALL_WDDX=${PHP_FPM_INSTALL_WDDX:-false}"
        - "INSTALL_XML=${PHP_FPM_INSTALL_XML:-false}"
        - "INSTALL_XMLRPC=${PHP_FPM_INSTALL_XMLRPC:-false}"
        - "INSTALL_XMLWRITER=${PHP_FPM_INSTALL_XMLWRITER:-false}"
        - "INSTALL_SOAP=${PHP_FPM_INSTALL_SOAP:-false}"
        - "INSTALL_PGSQL=${PHP_FPM_INSTALL_PGSQL:-false}"
        - "INSTALL_PG_CLIENT=${WORKSPACE_INSTALL_PG_CLIENT:-false}"
        - "INSTALL_XDEBUG=${PHP_FPM_INSTALL_XDEBUG:-false}"
        - "INSTALL_BLACKFIRE=${PHP_FPM_INSTALL_BLACKFIRE:-false}"
        - "INSTALL_PHPREDIS=${PHP_FPM_INSTALL_PHPREDIS:-false}"
        - "INSTALL_SWOOLE=${PHP_FPM_INSTALL_SWOOLE:-false}"
        - "INSTALL_MONGO=${PHP_FPM_INSTALL_MONGO:-false}"
        - "INSTALL_AMQP=${PHP_FPM_INSTALL_AMQP:-false}"
        - "INSTALL_ZIP_ARCHIVE=${PHP_FPM_INSTALL_ZIP_ARCHIVE:-false}"
        - "INSTALL_BCMATH=${PHP_FPM_INSTALL_BCMATH:-false}"
        - "INSTALL_GMP=${PHP_FPM_INSTALL_GMP:-false}"
        - "INSTALL_MEMCACHED=${PHP_FPM_INSTALL_MEMCACHED:-false}"
        - "INSTALL_EXIF=${PHP_FPM_INSTALL_EXIF:-false}"
        - "INSTALL_AEROSPIKE=${PHP_FPM_INSTALL_AEROSPIKE:-false}"
        - "INSTALL_OPCACHE=${PHP_FPM_INSTALL_OPCACHE:-false}"
        - "INSTALL_MYSQLI=${PHP_FPM_INSTALL_MYSQLI:-false}"
        - "INSTALL_TOKENIZER=${PHP_FPM_INSTALL_TOKENIZER:-false}"
        - "INSTALL_INTL=${PHP_FPM_INSTALL_INTL:-false}"
        - "INSTALL_PCNTL=${PHP_FPM_INSTALL_PCNTL:-false}"
        - "INSTALL_GHOSTSCRIPT=${PHP_FPM_INSTALL_GHOSTSCRIPT:-false}"
        - "INSTALL_LDAP=${PHP_FPM_INSTALL_LDAP:-false}"
        - "INSTALL_MSSQL=${PHP_FPM_INSTALL_MSSQL:-false}"
        - "INSTALL_V8JS=${PHP_FPM_INSTALL_V8JS:-false}"
        - "INSTALL_SUHOSIN=${PHP_FPM_INSTALL_SUHOSIN:-false}"
        - "INSTALL_INOTIFY=${PHP_FPM_INSTALL_INOTIFY:-false}"
        - "INSTALL_OPENCC=${PHP_FPM_INSTALL_OEPNCC:-false}"
        - "INSTALL_PROTOBUF=${PHP_FPM_INSTALL_PROTOBUF:-true}"
        - "INSTALL_IMAGE_OPTIMIZERS=${PHP_FPM_INSTALL_IMAGE_OPTIMIZERS:-false}"
        - "INSTALL_IMAGEMAGICK=${PHP_FPM_INSTALL_IMAGEMAGICK:-false}"
        - "INSTALL_PHP_CODE_QUALITY_TOOLS=${WORKSPACE_INSTALL_PHP_CODE_QUALITY:-false}"
        - "INSTALL_DRUSH=${WORKSPACE_INSTALL_DRUSH:-false}"
        - "INSTALL_DRUPAL_CONSOLE=${WORKSPACE_INSTALL_DRUPAL_CONSOLE:-false}"
        - "INSTALL_LARAVEL_ENVOY=${WORKSPACE_INSTALL_LARAVEL_ENVOY:-false}"
        - "INSTALL_LARAVEL_INSTALLER=${WORKSPACE_INSTALL_LARAVEL_INSTALLER:-false}"
        - "INSTALL_DEPLOYER=${WORKSPACE_INSTALL_DEPLOYER:-false}"
        - "INSTALL_LINUXBREW=${WORKSPACE_INSTALL_LINUXBREW:-false}"
        - "INSTALL_MC=${WORKSPACE_INSTALL_MC:-false}"
        - "INSTALL_SYMFONY=${WORKSPACE_INSTALL_SYMFONY:-false}"
        - "INSTALL_PYTHON=${WORKSPACE_INSTALL_PYTHON:-false}"
        - "INSTALL_PYTHON3=${WORKSPACE_INSTALL_PYTHON3:-false}"
        - "CHROME_DRIVER_VERSION=${WORKSPACE_CHROME_DRIVER_VERSION:-false}"
        - "INSTALL_DUSK_DEPS=${WORKSPACE_INSTALL_DUSK_DEPS:-false}"
        - "INSTALL_NODEJS=${WORKSPACE_INSTALL_NODEJS:-false}"
        - "NODEJS_VERSION=${WORKSPACE_NODEJS_VERSION:-9}"
        - "NODEJS_VERSION_BACKUP=${WORKSPACE_NODEJS_VERSION_BACKUP:-false}"
        - "INSTALL_YARN=${WORKSPACE_INSTALL_YARN:-false}"
        - "NODEJS_YARN_VERSION=${WORKSPACE_NODEJS_YARN_VERSION:-latest}"
        - "NODEJS_NVM_VERSION=${WORKSPACE_NODEJS_NVM_VERSION:-v0.33.8}"
        - "INSTALL_WORKSPACE_SSH=${WORKSPACE_INSTALL_WORKSPACE_SSH:-false}"
    volumes:
      - "${LOG_DATA_SAVE_PATH}/workspace:/var/log"
      - "./workspace/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini:ro"
      - "./workspace/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro"
      - "./workspace/php.ini:/usr/local/etc/php/php.ini:ro"
    volumes_from:
      - applications
    environment:
      - "PHP_IDE_CONFIG=${PHP_IDE_CONFIG:-dev.com}"
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP:-10.3.2.1}"
    expose:
      - "9000"
    ports:
      - "${WORKSPACE_SSH_PORT:-22}:22"
      - "${WORKSPACE_PHP_XDEBUG_PORT}:9001"
    tty: true
    restart: ${WORKSPACE_RESTART:-always}
    networks:
      - frontend
      - backend

  swoole:
    build:
      context: ./swoole
      args:
        - "PHP_VERSION=${PHP_VERSION:-7.2}"
        - "NPROC=${NPROC:-1}"
        - "TZ=${TIMEZONE:-UTC}"
        - "PUID=${PUID:-1000}"
        - "PGID=${PGID:-1000}"
        - "LINUX_USER=${LINUX_USER:-kimhsiao}"
        - "SWOOLE_VERSION=${SWOOLE_VERSION:-master}"
        - "CANVAS_SUPPORT=${SWOOLE_CANVAS_SUPPORT:-false}"
        - "INSTALL_MCRYPT=${SWOOLE_INSTALL_MCRYPT:-false}"
        - "INSTALL_PDO_MYSQL=${SWOOLE_INSTALL_PDO_MYSQL:-false}"
        - "INSTALL_PDO_PGSQL=${SWOOLE_INSTALL_PDO_PGSQL:-false}"
        - "INSTALL_PDO_SQLITE=${SWOOLE_INSTALL_PDO_SQLITE:-false}"
        - "INSTALL_GD=${SWOOLE_INSTALL_GD:-false}"
        - "INSTALL_APC=${SWOOLE_INSTALL_APC:-false}"
        - "INSTALL_FTP=${SWOOLE_INSTALL_FTP:-false}"
        - "INSTALL_XSL=${SWOOLE_INSTALL_XSL:-false}"
        - "INSTALL_CALENDAR=${SWOOLE_INSTALL_CALENDAR:-false}"
        - "INSTALL_CTYPE=${SWOOLE_INSTALL_CTYPE:-false}"
        - "INSTALL_DBA=${SWOOLE_INSTALL_DBA:-false}"
        - "INSTALL_DOM=${SWOOLE_INSTALL_DOM:-false}"
        - "INSTALL_JSON=${SWOOLE_INSTALL_JSON:-false}"
        - "INSTALL_HASH=${SWOOLE_INSTALL_HASH:-false}"
        - "INSTALL_SOCKETS=${SWOOLE_INSTALL_SOCKETS:-false}"
        - "INSTALL_PDO=${SWOOLE_INSTALL_PDO:-false}"
        - "INSTALL_MBSTRING=${SWOOLE_INSTALL_MBSTRING:-false}"
        - "INSTALL_IMAP=${SWOOLE_INSTALL_IMAP:-false}"
        - "INSTALL_CURL=${SWOOLE_INSTALL_CURL:-false}"
        - "INSTALL_FILEINFO=${SWOOLE_INSTALL_FILEINFO:-false}"
        - "INSTALL_GETTEXT=${SWOOLE_INSTALL_GETTEXT:-false}"
        - "INSTALL_ICONV=${SWOOLE_INSTALL_ICONV:-false}"
        - "INSTALL_PHAR=${SWOOLE_INSTALL_PHAR:-false}"
        - "INSTALL_POSIX=${SWOOLE_INSTALL_POSIX:-false}"
        - "INSTALL_PSPELL=${SWOOLE_INSTALL_PSPELL:-false}"
        - "INSTALL_READLINE=${SWOOLE_INSTALL_READLINE:-false}"
        - "INSTALL_RECODE=${SWOOLE_INSTALL_RECODE:-false}"
        - "INSTALL_SHMOP=${SWOOLE_INSTALL_SHMOP:-false}"
        - "INSTALL_SIMPLEXML=${SWOOLE_INSTALL_SIMPLEXML:-false}"
        - "INSTALL_SNMP=${SWOOLE_INSTALL_SNMP:-false}"
        - "INSTALL_SYSVMSG=${SWOOLE_INSTALL_SYSVMSG:-false}"
        - "INSTALL_SYSVSEM=${SWOOLE_INSTALL_SYSVSEM:-false}"
        - "INSTALL_SYSVSHM=${SWOOLE_INSTALL_SYSVSHM:-false}"
        - "INSTALL_BZ2=${SWOOLE_INSTALL_BZ2:-false}"
        - "INSTALL_ENCHANT=${SWOOLE_INSTALL_ENCHANT:-false}"
        - "INSTALL_YAML=${SWOOLE_INSTALL_YAML:-false}"
        - "INSTALL_EVENT=${SWOOLE_INSTALL_EVENT:-false}"
        - "INSTALL_TIDY=${SWOOLE_INSTALL_TIDY:-false}"
        - "INSTALL_WDDX=${SWOOLE_INSTALL_WDDX:-false}"
        - "INSTALL_XML=${SWOOLE_INSTALL_XML:-false}"
        - "INSTALL_XMLRPC=${SWOOLE_INSTALL_XMLRPC:-false}"
        - "INSTALL_XMLWRITER=${SWOOLE_INSTALL_XMLWRITER:-false}"
        - "INSTALL_SOAP=${SWOOLE_INSTALL_SOAP:-false}"
        - "INSTALL_PGSQL=${SWOOLE_INSTALL_PGSQL:-false}"
        - "INSTALL_PG_CLIENT=${SWOOLE_INSTALL_PG_CLIENT:-false}"
        - "INSTALL_BLACKFIRE=${SWOOLE_INSTALL_BLACKFIRE:-false}"
        - "INSTALL_PHPREDIS=${SWOOLE_INSTALL_PHPREDIS:-false}"
        - "INSTALL_MONGO=${SWOOLE_INSTALL_MONGO:-false}"
        - "INSTALL_AMQP=${SWOOLE_INSTALL_AMQP:-false}"
        - "INSTALL_ZIP_ARCHIVE=${SWOOLE_INSTALL_ZIP_ARCHIVE:-false}"
        - "INSTALL_BCMATH=${SWOOLE_INSTALL_BCMATH:-false}"
        - "INSTALL_GMP=${SWOOLE_INSTALL_GMP:-false}"
        - "INSTALL_MEMCACHED=${SWOOLE_INSTALL_MEMCACHED:-false}"
        - "INSTALL_EXIF=${SWOOLE_INSTALL_EXIF:-false}"
        - "INSTALL_AEROSPIKE=${SWOOLE_INSTALL_AEROSPIKE:-false}"
        - "INSTALL_OPCACHE=${SWOOLE_INSTALL_OPCACHE:-false}"
        - "INSTALL_MYSQLI=${SWOOLE_INSTALL_MYSQLI:-false}"
        - "INSTALL_TOKENIZER=${SWOOLE_INSTALL_TOKENIZER:-false}"
        - "INSTALL_INTL=${SWOOLE_INSTALL_INTL:-false}"
        - "INSTALL_PCNTL=${SWOOLE_INSTALL_PCNTL:-false}"
        - "INSTALL_GHOSTSCRIPT=${SWOOLE_INSTALL_GHOSTSCRIPT:-false}"
        - "INSTALL_LDAP=${SWOOLE_INSTALL_LDAP:-false}"
        - "INSTALL_MSSQL=${SWOOLE_INSTALL_MSSQL:-false}"
        - "INSTALL_V8JS=${SWOOLE_INSTALL_V8JS:-false}"
        - "INSTALL_SUHOSIN=${SWOOLE_INSTALL_SUHOSIN:-false}"
        - "INSTALL_INOTIFY=${SWOOLE_INSTALL_INOTIFY:-false}"
        - "INSTALL_OPENCC=${SWOOLE_INSTALL_OEPNCC:-false}"
        - "INSTALL_PROTOBUF=${SWOOLE_INSTALL_PROTOBUF:-true}"
        - "INSTALL_IMAGE_OPTIMIZERS=${SWOOLE_INSTALL_IMAGE_OPTIMIZERS:-false}"
        - "INSTALL_IMAGEMAGICK=${SWOOLE_INSTALL_IMAGEMAGICK:-false}"
        - "INSTALL_PHP_CODE_QUALITY_TOOLS=${SWOOLE_INSTALL_PHP_CODE_QUALITY:-false}"
        - "INSTALL_DRUSH=${SWOOLE_INSTALL_DRUSH:-false}"
        - "INSTALL_DRUPAL_CONSOLE=${SWOOLE_INSTALL_DRUPAL_CONSOLE:-false}"
        - "INSTALL_LARAVEL_ENVOY=${SWOOLE_INSTALL_LARAVEL_ENVOY:-false}"
        - "INSTALL_LARAVEL_INSTALLER=${SWOOLE_INSTALL_LARAVEL_INSTALLER:-false}"
        - "INSTALL_DEPLOYER=${SWOOLE_INSTALL_DEPLOYER:-false}"
        - "INSTALL_LINUXBREW=${SWOOLE_INSTALL_LINUXBREW:-false}"
        - "INSTALL_MC=${SWOOLE_INSTALL_MC:-false}"
        - "INSTALL_SYMFONY=${SWOOLE_INSTALL_SYMFONY:-false}"
        - "INSTALL_PYTHON=${SWOOLE_INSTALL_PYTHON:-false}"
        - "INSTALL_PYTHON3=${SWOOLE_INSTALL_PYTHON3:-false}"
        - "CHROME_DRIVER_VERSION=${SWOOLE_CHROME_DRIVER_VERSION:-false}"
        - "INSTALL_DUSK_DEPS=${SWOOLE_INSTALL_DUSK_DEPS:-false}"
        - "INSTALL_NODEJS=${SWOOLE_INSTALL_NODEJS:-false}"
        - "NODEJS_VERSION=${SWOOLE_NODEJS_VERSION:-9}"
        - "NODEJS_VERSION_BACKUP=${SWOOLE_NODEJS_VERSION_BACKUP:-false}"
        - "INSTALL_YARN=${SWOOLE_INSTALL_YARN:-false}"
        - "NODEJS_YARN_VERSION=${SWOOLE_NODEJS_YARN_VERSION:-latest}"
        - "NODEJS_NVM_VERSION=${SWOOLE_NODEJS_NVM_VERSION:-v0.33.8}"
        - "INSTALL_SWOOLE_SSH=${SWOOLE_INSTALL_SWOOLE_SSH:-false}"
        - "ENTRYPOINT_FILE=${SWOOLE_ENTRYPOINT_FILE:-hyperf}"
        - "CUSTOM_PORT=${SWOOLE_CUSTOM_PORT:-9501}"
        - "WEBSOCKET_PORT=${SWOOLE_WEBSOCKET_PORT:-9502}"
    volumes:
      - "${LOG_DATA_SAVE_PATH}/swoole:/var/log"
      - "./swoole/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro"
      - "./swoole/php.ini:/usr/local/etc/php/php.ini:ro"
    volumes_from:
      - applications
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP:-10.3.2.1}"
    ports:
      - "${SWOOLE_SSH_PORT:-22}:22"
      - "${SWOOLE_CUSTOM_EXT_PORT:-9500}:${SWOOLE_CUSTOM_PORT:-9501}"
      - "${SWOOLE_WEBSOCKET_EXT_PORT:-9600}:${SWOOLE_WEBSOCKET_PORT:-9502}"
    tty: true
    restart: ${SWOOLE_RESTART:-always}
    networks:
      - frontend
      - backend

  php-fpm:
    build:
      context: ./php-fpm
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "PHP_VERSION=${PHP_VERSION:-7.2}"
        - "NPROC=${NPROC:-1}"
        - "INSTALL_MCRYPT=${PHP_FPM_INSTALL_MCRYPT:-false}"
        - "INSTALL_PDO_MYSQL=${PHP_FPM_INSTALL_PDO_MYSQL:-false}"
        - "INSTALL_PDO_PGSQL=${PHP_FPM_INSTALL_PDO_PGSQL:-false}"
        - "INSTALL_PDO_SQLITE=${PHP_FPM_INSTALL_PDO_SQLITE:-false}"
        - "INSTALL_GD=${PHP_FPM_INSTALL_GD:-false}"
        - "INSTALL_APC=${PHP_FPM_INSTALL_APC:-false}"
        - "INSTALL_FTP=${PHP_FPM_INSTALL_FTP:-false}"
        - "INSTALL_XSL=${PHP_FPM_INSTALL_XSL:-false}"
        - "INSTALL_CALENDAR=${PHP_FPM_INSTALL_CALENDAR:-false}"
        - "INSTALL_CTYPE=${PHP_FPM_INSTALL_CTYPE:-false}"
        - "INSTALL_DBA=${PHP_FPM_INSTALL_DBA:-false}"
        - "INSTALL_DOM=${PHP_FPM_INSTALL_DOM:-false}"
        - "INSTALL_JSON=${PHP_FPM_INSTALL_JSON:-false}"
        - "INSTALL_HASH=${PHP_FPM_INSTALL_HASH:-false}"
        - "INSTALL_SOCKETS=${PHP_FPM_INSTALL_SOCKETS:-false}"
        - "INSTALL_PDO=${PHP_FPM_INSTALL_PDO:-false}"
        - "INSTALL_MBSTRING=${PHP_FPM_INSTALL_MBSTRING:-false}"
        - "INSTALL_IMAP=${PHP_FPM_INSTALL_IMAP:-false}"
        - "INSTALL_CURL=${PHP_FPM_INSTALL_CURL:-false}"
        - "INSTALL_FILEINFO=${PHP_FPM_INSTALL_FILEINFO:-false}"
        - "INSTALL_GETTEXT=${PHP_FPM_INSTALL_GETTEXT:-false}"
        - "INSTALL_ICONV=${PHP_FPM_INSTALL_ICONV:-false}"
        - "INSTALL_PHAR=${PHP_FPM_INSTALL_PHAR:-false}"
        - "INSTALL_POSIX=${PHP_FPM_INSTALL_POSIX:-false}"
        - "INSTALL_PSPELL=${PHP_FPM_INSTALL_PSPELL:-false}"
        - "INSTALL_READLINE=${PHP_FPM_INSTALL_READLINE:-false}"
        - "INSTALL_RECODE=${PHP_FPM_INSTALL_RECODE:-false}"
        - "INSTALL_SHMOP=${PHP_FPM_INSTALL_SHMOP:-false}"
        - "INSTALL_SIMPLEXML=${PHP_FPM_INSTALL_SIMPLEXML:-false}"
        - "INSTALL_SNMP=${PHP_FPM_INSTALL_SNMP:-false}"
        - "INSTALL_SYSVMSG=${PHP_FPM_INSTALL_SYSVMSG:-false}"
        - "INSTALL_SYSVSEM=${PHP_FPM_INSTALL_SYSVSEM:-false}"
        - "INSTALL_SYSVSHM=${PHP_FPM_INSTALL_SYSVSHM:-false}"
        - "INSTALL_BZ2=${PHP_FPM_INSTALL_BZ2:-false}"
        - "INSTALL_ENCHANT=${PHP_FPM_INSTALL_ENCHANT:-false}"
        - "INSTALL_YAML=${PHP_FPM_INSTALL_YAML:-false}"
        - "INSTALL_EVENT=${PHP_FPM_INSTALL_EVENT:-false}"
        - "INSTALL_TIDY=${PHP_FPM_INSTALL_TIDY:-false}"
        - "INSTALL_WDDX=${PHP_FPM_INSTALL_WDDX:-false}"
        - "INSTALL_XML=${PHP_FPM_INSTALL_XML:-false}"
        - "INSTALL_XMLRPC=${PHP_FPM_INSTALL_XMLRPC:-false}"
        - "INSTALL_XMLWRITER=${PHP_FPM_INSTALL_XMLWRITER:-false}"
        - "INSTALL_SOAP=${PHP_FPM_INSTALL_SOAP:-false}"
        - "INSTALL_PGSQL=${PHP_FPM_INSTALL_PGSQL:-false}"
        - "INSTALL_XDEBUG=${PHP_FPM_INSTALL_XDEBUG:-false}"
        - "INSTALL_BLACKFIRE=${PHP_FPM_INSTALL_BLACKFIRE:-false}"
        - "INSTALL_PHPREDIS=${PHP_FPM_INSTALL_PHPREDIS:-false}"
        - "INSTALL_SWOOLE=${PHP_FPM_INSTALL_SWOOLE:-false}"
        - "INSTALL_MONGO=${PHP_FPM_INSTALL_MONGO:-false}"
        - "INSTALL_AMQP=${PHP_FPM_INSTALL_AMQP:-false}"
        - "INSTALL_ZIP_ARCHIVE=${PHP_FPM_INSTALL_ZIP_ARCHIVE:-false}"
        - "INSTALL_BCMATH=${PHP_FPM_INSTALL_BCMATH:-false}"
        - "INSTALL_GMP=${PHP_FPM_INSTALL_GMP:-false}"
        - "INSTALL_MEMCACHED=${PHP_FPM_INSTALL_MEMCACHED:-false}"
        - "INSTALL_EXIF=${PHP_FPM_INSTALL_EXIF:-false}"
        - "INSTALL_AEROSPIKE=${PHP_FPM_INSTALL_AEROSPIKE:-false}"
        - "INSTALL_OPCACHE=${PHP_FPM_INSTALL_OPCACHE:-false}"
        - "INSTALL_MYSQLI=${PHP_FPM_INSTALL_MYSQLI:-false}"
        - "INSTALL_TOKENIZER=${PHP_FPM_INSTALL_TOKENIZER:-false}"
        - "INSTALL_INTL=${PHP_FPM_INSTALL_INTL:-false}"
        - "INSTALL_PCNTL=${PHP_FPM_INSTALL_PCNTL:-false}"
        - "INSTALL_V8JS=${PHP_FPM_INSTALL_V8JS:-false}"
        - "INSTALL_SUHOSIN=${PHP_FPM_INSTALL_SUHOSIN:-false}"
        - "INSTALL_INOTIFY=${PHP_FPM_INSTALL_INOTIFY:-false}"
        - "INSTALL_OPENCC=${PHP_FPM_INSTALL_OEPNCC:-false}"
        - "INSTALL_PROTOBUF=${PHP_FPM_INSTALL_PROTOBUF:-true}"
        - "INSTALL_GHOSTSCRIPT=${PHP_FPM_INSTALL_GHOSTSCRIPT:-false}"
        - "INSTALL_LDAP=${PHP_FPM_INSTALL_LDAP:-false}"
        - "INSTALL_MSSQL=${PHP_FPM_INSTALL_MSSQL:-false}"
        - "INSTALL_IMAGE_OPTIMIZERS=${PHP_FPM_INSTALL_IMAGE_OPTIMIZERS:-false}"
        - "INSTALL_IMAGEMAGICK=${PHP_FPM_INSTALL_IMAGEMAGICK:-false}"
    volumes_from:
      - applications
    volumes:
      - "./php-fpm/laravel.ini:/usr/local/etc/php/php.ini:ro"
      - "${LOG_DATA_SAVE_PATH}/php-fpm:/var/log"
      - "./php-fpm/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini:ro"
      - "./php-fpm/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro"
    expose:
      - "9000"
    ports:
      - "${PHP_FPM_PHP_XDEBUG_PORT}:9001"
    depends_on:
      - workspace
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP:-10.3.2.1}"
    environment:
      - "PHP_IDE_CONFIG=${PHP_IDE_CONFIG:-dev.com}"
    restart: ${PHP_FPM_RESTART:-always}
    networks:
      - backend

  caddy:
    build:
      context: ./caddy
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "CADDY_PLUGINS=${CADDY_PLUGINS:-http}"
        - "CADDY_LICENSE=${CADDY_LICENSE:-personal}"
        - "HTTP_PORT=${HTTP_PORT:-80}"
        - "HTTPS_PORT=${HTTPS_PORT:-443}"
        - "HTTP_OTHER_PORT=${HTTP_OTHER_PORT:-2018}"
    volumes_from:
      - applications
    volumes:
      - "${CADDY_CUSTOM_CADDYFILE:-./Caddyfile}:/etc/CaddyFile"
      - "${LOG_DATA_SAVE_PATH}/caddy:/var/log"
      - "${DATA_SAVE_PATH}/caddy:/root/.caddy"
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${HTTP_OTHER_PORT:-2018}:2018"
    depends_on:
      - workspace
    restart: ${CADDY_RESTART:-always}
    networks:
      - frontend
      - backend
  nginx:
    build:
      context: ./nginx
      args:
        - "NGINX_VERSION=${NGINX_VERSION:-latest}"
        - "TZ=${TIMEZONE:-UTC}"
        - "PHP_UPSTREAM_CONTAINER=${NGINX_PHP_UPSTREAM_CONTAINER:-workspace}"
        - "PHP_UPSTREAM_PORT=${NGINX_PHP_UPSTREAM_PORT:-9000}"
    volumes_from:
      - applications
    volumes:
      - "${LOG_DATA_SAVE_PATH}/nginx:/var/log/nginx"
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./nginx/conf.d:/etc/nginx/conf.d"
      - "${NGINX_SITES_PATH:-./nginx/sites-enabled}:/etc/nginx/sites-enabled:ro"
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${HTTP_OTHER_PORT:-2018}:2018"
    depends_on:
      - workspace
    restart: ${NGINX_RESTART:-always}
    networks:
      - frontend
      - backend

  nginx-adv:
    build:
      context: ./nginx-adv
      args:
        - "NPROC=${NPROC:-1}"
        - "ALPINE_VERSION=${NGINX_ADV_ALPINE_VERSION:-latest}"
        - "NGINX_VERSION=${NGINX_ADV_VERSION:-1.19.2}"
        - "NGINX_DEVEL_KIT_VERSION=${NGINX_ADV_DEV_KIT_VERSION:-0.3.1}"
        - "NGINX_RTMP_MODULE_VERSION=${NGINX_ADV_RTMP_VERSION:-1.2.1}"
        - "NGINX_LUA_MODULE_VERSION=${NGINX_ADV_LUA_VERSION:-0.10.17}"
        - "NGINX_STREAM_LUA_MODULE_VERSION=${NGINX_ADV_STREAM_LUA_VERSION:-0.0.8}"
        - "NGINX_LUA_RESTY_LRUCACHE_VERSION=${NGINX_ADV_LUA_RESTY_LRUCACHE_VERSION:-0.10}"
        - "NGINX_LUA_RESTY_VERSION=${NGINX_ADV_LUA_RESTY_VERSION:-0.1.16}"
        - "LUA_JIT_VERSION=${NGINX_ADV_LUAJIT_VERSION:-2.0.5}"
        - "FFMPEG_VERSION=${NGINX_ADV_FFMPEG_VERSION:-4.3.1}"
        - "LUAROCKS_VERSION=${NGINX_ADV_LUAROCKS_VERSION:-3.3.1}"
        - "OPENRESTY_VERSION=${NGINX_ADV_OPENRESTY_VERSION:-1.17.8.2}"
        - "HEADERS_MORE_MODULE_VERSION=${NGINX_ADV_HEADERS_MORE_MODULE_VERSION:-0.33}"
        - "NGINX_VOD_MODULE_VERSION=${NGINX_ADV_VOD_MODULE_VERSION:-1.27}"
        - "NGINX_UPLOAD_PROGRESS_MODULE_VERSION=${NGINX_ADV_UPLOAD_PROGRESS_MODULE_VERSION:-0.9.2}"
        - "TZ=${TIMEZONE:-UTC}"
    volumes_from:
      - applications
    volumes:
      - "${DATA_SAVE_PATH}/nginx-adv/cache:/var/cache/nginx"
      - "${LOG_DATA_SAVE_PATH}/nginx-adv:/var/log/nginx"
      - "./nginx-adv/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./nginx-adv/conf.d:/etc/nginx/conf.d"
      - "${NGINX_ADV_SITES_PATH:-./nginx-adv/sites-enabled}:/etc/nginx/sites-enabled:ro"
    ports:
      - "${NGINX_ADV_RTMP_PORT:-1935}:1935"
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${HTTP_OTHER_PORT:-2018}:2018"
    depends_on:
      - workspace
    restart: ${NGINX_ADV_RESTART:-always}
    networks:
      - frontend
      - backend

  python3:
    build:
      context: ./python3
      args:
        - "PYTHON3_VERSION=${PYTHON3_VERSION:-3.8}"
        - "APP_POINTER=${APP_POINTER:-/usr/src/app}"
        - "TZ=${TIMEZONE:-UTC}"
    volumes_from:
      - applications
    volumes:
      - "${LOG_DATA_SAVE_PATH}/python3:${PYTHON3_LOG_DIR:-/var/log/python3}"
      - "./python3/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro"
    expose:
      - "${PYTHON3_EXPOSE:-8003}"
    ports:
      - "${PYTHON3_PORT}:8000"
    entrypoint: "/usr/local/bin/docker-entrypoint.sh"
    restart: ${PYTHON3_RESTART:-always}
    networks:
      - frontend
      - backend

  mariadb:
    build:
      context: ./mariadb
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MARIADB_VERSION=${MARIADB_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/mariadb:/var/lib/mysql"
      - "${MARIADB_ENTRYPOINT_INITDB}:/docker-entrypoint-initdb.d"
      - "${LOG_DATA_SAVE_PATH}/mariadb:/var/log"
    ports:
      - "${MARIADB_PORT:-3306}:3306"
    environment:
      - "MYSQL_DATABASE=${MARIADB_DATABASE:-default}"
      - "MYSQL_USER=${MARIADB_USER:-default}"
      - "MYSQL_PASSWORD=${MARIADB_PASSWORD:-secret}"
      - "MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD:-root}"
    restart: ${MARIADB_RESTART:-always}
    networks:
      - backend

  mysql:
    build:
      context: ./mysql
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MYSQL_VERSION=${MYSQL_VERSION:-latest}"
    volumes:
      # - "${DATA_SAVE_PATH}/mysql:/var/lib/mysql"
      - "mysql_data:/var/lib/mysql"
      - "${MYSQL_ENTRYPOINT_INITDB}:/docker-entrypoint-initdb.d"
      - "${LOG_DATA_SAVE_PATH}/mysql:/var/log"
      - "./mysql/${MYSQL_CONFIG_FILE:-my.cnf}:/etc/conf.d/my.cnf:ro"
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      - "MYSQL_DATABASE=${MYSQL_DATABASE:-default}"
      - "MYSQL_USER=${MYSQL_USER:-default}"
      - "MYSQL_PASSWORD=${MYSQL_PASSWORD:-secret}"
      - "MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}"
      - "TZ=${TIMEZONE:-UTC}"
    restart: ${MYSQL_RESTART:-always}
    networks:
      - backend

  percona:
    build:
      context: ./percona
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "PERCONA_VERSION=${PERCONA_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/percona:/var/lib/mysql"
      - "${LOG_DATA_SAVE_PATH}/percona:/var/log"
    environment:
      - "MYSQL_DATABASE=${PERCONA_DATABASE:-default}"
      - "MYSQL_USER=${PERCONA_USER:-default}"
      - "MYSQL_PASSWORD=${PERCONA_PASSWORD:-secret}"
      - "MYSQL_ROOT_PASSWORD=${PERCONA_ROOT_PASSWORD:-root}"
      - "TZ=${TIMEZONE:-UTC}"
    ports:
      - "${PERCONA_PORT:-3306}:3306"
    restart: ${PERCONA_RESTART:-always}
    networks:
      - backend

  postgres:
    build:
      context: ./postgres
      args:
        - "POSTGRES_VERSION=${POSTGRES_VERSION:-latest}"
        - "TZ=${TIMEZONE:-UTC}"
    volumes:
      - "postgres_data:/var/lib/postgresql/data"
      - "${LOG_DATA_SAVE_PATH}/postgres:/var/log"
    environment:
      - "POSTGRES_DB=${POSTGRES_DB:-default}"
      - "POSTGRES_USER=${POSTGRES_USER:-default}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secret}"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: ${POSTGRES_RESTART:-always}
    networks:
      - backend

  postgis:
    build:
      context: ./postgis
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "POSTGIS_VERSION=${POSTGIS_VERSION:-latest}"
    volumes:
      - postgis_data:/var/lib/postgresql/data
      - "${LOG_DATA_SAVE_PATH}/postgis:/var/log"
    environment:
      - "POSTGRES_DB=${POSTGRES_DB:-default}"
      - "POSTGRES_USER=${POSTGRES_USER:-default}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secret}"
    ports:
      - "${POSTGIS_PORT:-5432}:5432"
    restart: ${POSTGIS_RESTART:-always}
    networks:
      - backend

  elasticsearch:
    build:
      context: ./elasticsearch
      args:
        - "ELASTICSEARCH_VERSION=${ELASTICSEARCH_VERSION:-6.2.2}"
        - "ELASTICSEARCH_ENABLE_SECURITY=${ELASTICSEARCH_ENABLE_SECURITY:-false}"
        - "ELASTICSEARCH_SMARTCN_ANALYZER=${ELASTICSEARCH_SMARTCN_ANALYZER:-false}"
        - "ELASTICSEARCH_IK_ANALYZER=${ELASTICSEARCH_IK_ANALYZER:-false}"
        - "ELASTICSEARCH_ANSJ_ANALYZER=${ELASTICSEARCH_ANSJ_ANALYZER:-false}"
    environment:
      - "http.host=${ELASTICSEARCH_HTTP_HOST:-9200}"
      - "transport.host=${ELASTICSEARCH_TRANSPORT_HOST:-9300}"
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms${ELASTICSEARCH_MIN_MEMORY:-512m} -Xmx${ELASTICSEARCH_MAX_MEMORY}"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: "${ELASTICSEARCH_LIMIT_MEMORY:-1g}"
    volumes:
      - "./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro"
      - "${LOG_DATA_SAVE_PATH}/elasticsearch:/var/log"
      - "${DATA_SAVE_PATH}/elasticsearch:/usr/share/elasticsearch/data"
    ports:
      - "${ELASTICSEARCH_HOST_HTTP_PORT:-9200}:9200"
      - "${ELASTICSEARCH_HOST_TRANSPORT_PORT:-9300}:9300"
    restart: ${ELASTICSEARCH_RESTART:-always}
    networks:
      - backend
      - frontend

  mongo:
    build:
      context: ./mongo
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MONGO_VERSION=${MONGO_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/mongo:/data/db"
      - "${LOG_DATA_SAVE_PATH}/mongo:/var/log"
    ports:
      - "${MONGO_PORT:-27017}:27017"
    restart: ${MONGO_RESTART:-always}
    networks:
      - backend

  redis:
    build:
      context: ./redis
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "REDIS_VERSION=${REDIS_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/redis:/data"
      - "${LOG_DATA_SAVE_PATH}/redis:/var/log"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    restart: ${REDIS_RESTART:-always}
    networks:
      - backend

  memcached:
    build:
      context: ./memcached
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MEMCACHED_VERSION=${MEMCACHED_VERSION:-latest}"
    volumes:
      - "${LOG_DATA_SAVE_PATH}/memcached:/var/log"
    ports:
      - "${MEMCACHED_PORT:-11211}:11211"
    restart: ${MEMCACHED_RESTART:-always}
    networks:
      - backend

  minio:
    build:
      context: ./minio
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MINIO_VERSION=${MINIO_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/minio/data:/export"
      - "${DATA_SAVE_PATH}/minio/config:/root/.minio"
    ports:
      - "${MINIO_PORT}:9000"
    environment:
      - "MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-access}"
      - "MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-secretkey}"
    networks:
      - backend
      - frontend

  kibana:
    build:
      context: ./kibana
      args:
        - "KIBANA_VERSION=${KIBANA_VERSION:-6.2.2}"
        - "KIBANA_ENABLE_SECURITY=${KIBANA_ENABLE_SECURITY:-false}"
    environment:
      - "ELASTICSEARCH_URLS=${KIBANA_ELASTICSEARCH_URLS:-elasticsearch:9200}"
      # - "ELASTICSEARCH_URL=http://elasticsearch:${ELASTICSEARCH_HOST_HTTP_PORT:-9300}"
      # - "XPACK_MONITORING_ENABLED=${KIBANA_ENABLE_SECURITY:-false}"
    volumes:
      - "./kibana/config:/usr/share/kibana/config:ro"
      - "${LOG_DATA_SAVE_PATH}/kibana:/var/log"
      - "${DATA_SAVE_PATH}/kibana:/usr/share/kibana/data"
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    restart: ${KIBANA_RESTART:-always}
    networks:
      - frontend
      - backend

  logstash:
    build:
      context: ./logstash
      args:
        - "LOGSTASH_VERSION=${LOGSTASH_VERSION:-6.2.2}"
        - "LOGSTASH_PLUGINS=${LOGSTASH_PLUGINS:-NONE}"
    environment:
      - "LS_JAVA_OPTS=-Xms${LOGSTASH_MIN_MEMORY:-256m} -Xmx${LOGSTASH_MAX_MEMORY:-256m}"
    volumes:
      - "./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro"
      - "./logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml:ro"
      - "./logstash/pipelines:/usr/share/logstash/pipeline"
      - "${DATA_SAVE_PATH}/logstash/data:/usr/share/logstash/data"
      - "${LOG_DATA_SAVE_PATH}/logstash:/var/log"
    ports:
      - "${LOGSTASH_PORT_RANGE:-5041-5050}:5041-5050"
      - "${LOGSTASH_UDP_PORT:-10101}:10101/udp"
    restart: ${LOGSTASH_RESTART:-always}
    networks:
      - backend
      - frontend

  rethinkdb:
    build:
      context: ./rethinkdb
      args:
        - "RETHINKDB_VERSION=${RETHINKDB_VERSION:-latest}"
        - "TZ=${TIMEZONE:-UTC}"
    volumes:
      - "${DATA_SAVE_PATH}/rethinkdb:/data/rethinkdb_data"
      - "${LOG_DATA_SAVE_PATH}/rethinkdb:/var/log"
    ports:
      - "${RETHINKDB_PORT}:8080"
    restart: ${RETHINKDB_RESTART:-always}
    networks:
      - backend

  rabbitmq:
    build:
      context: ./rabbitmq
      args:
        - "RABBITMQ_VERSION=${RABBITMQ_VERSION:-latest}"
        - "TZ=${TIMEZONE:-UTC}"
    environment:
      - "RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-test}"
      - "RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-test}"
      - "RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-/}"
      - "RABBITMQ_ERLANG_COOKIE=${RABBITMQ_COOKIE:-test}"
    volumes:
      - "${LOG_DATA_SAVE_PATH}/rabbitmq:/var/log"
      - "${DATA_SAVE_PATH}/rabbitmq/config:/var/lib/rabbitmq/config"
      - "${DATA_SAVE_PATH}/rabbitmq/mnesia:/var/lib/rabbitmq/mnesia"
      - "${DATA_SAVE_PATH}/rabbitmq/schema:/var/lib/rabbitmq/schema"
    ports:
      - "${RABBITMQ_EPMD_PORT:-4369}:4369"
      - "${RABBITMQ_NODE_HOST_PORT_SSL:-5671}:5671"
      - "${RABBITMQ_NODE_HOST_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_HTTP_HOST_PORT:-15672}:15672"
      - "${RABBITMQ_MANAGEMENT_HTTPS_HOST_PORT:-15671}:15671"
      - "${RABBITMQ_CLUSTER_PORT:-25672}:25672"
    restart: ${RABBITMQ_RESTART:-always}
    networks:
      - backend

  php-worker:
    build:
      context: ./php-worker
      args:
        - "PHP_VERSION=${PHP_VERSION}"
        - "INSTALL_MYSQLI=${PHP_FPM_INSTALL_MYSQLI:-true}"
        - "INSTALL_MBSTRING=${PHP_FPM_INSTALL_MBSTRING:-true}"
        - "INSTALL_JSON=${PHP_FPM_INSTALL_JSON:-true}"
        - "INSTALL_CURL=${PHP_FPM_INSTALL_CURL:-true}"
        - "INSTALL_ICONV=${PHP_FPM_INSTALL_ICONV:-true}"
        - "INSTALL_TOKENIZER=${PHP_FPM_INSTALL_TOKENIZER:-true}"
        - "INSTALL_BCMATH=${PHP_FPM_INSTALL_BCMATH:-true}"
        - "INSTALL_EXIF={PHP_FPM_INSTALL_EXIF:-true}"
        - "INSTALL_XML=${PHP_FPM_INSTALL_XML:-true}"
        - "INSTALL_INTL=${PHP_FPM_INSTALL_INTL:-true}"
        - "INSTALL_GMP=${PHP_FPM_INSTALL_GMP:-true}"
        - "INSTALL_PGSQL=${PHP_FPM_INSTALL_PGSQL:-true}"
        - "INSTALL_PHPREDIS=${PHP_FPM_INSTALL_PHPREDIS:-true}"
        - "INSTALL_MEMCACHED=${PHP_FPM_INSTALL_MEMCACHED:-true}"
        - "TZ=${TIMEZONE:-UTC}"
    volumes:
      - "${LOG_DATA_SAVE_PATH}/php-worker:/var/log"
      - "./php-worker/supervisord.conf:/etc/supervisord.conf:ro"
    volumes_from:
      - applications
    depends_on:
      - workspace
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP}"
    restart: ${PHP_WORKER_RESTART:-always}
    networks:
      - backend

  phpmyadmin:
    build:
      context: ./phpmyadmin
      args:
        - "PMA_VERSION=${PMA_VERSION:-latest}"
    environment:
      - PMA_ARBITRARY=1
      - "PMA_HOST=${PMA_HOST:-mariadb}"
      - "PMA_PORT=${PMA_PORT:-3306}"
      - "PMA_USER=${PMA_USER:-root}"
      - "PMA_PASSWORD=${PMA_PASSWORD:-root}"
    ports:
      - "${PMA_EXT_PORT:-80}:80"
    depends_on:
      - "${PMA_DB_ENGINE:-mariadb}"
    restart: ${PMA_RESTART:-always}
    networks:
      - backend
      - frontend

  gitlab:
    image: "gitlab/gitlab-ce:${GITLAB_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/gitlab/${GITLAB_CONF_DIR:-config}:/etc/gitlab"
      - "${DATA_SAVE_PATH}/gitlab/${GITLAB_HOME_DIR:-home}:/var/opt/gitlab"
      - "${LOG_DATA_SAVE_PATH}/gitlab:/var/log/gitlab"
    ports:
      - "${GITLAB_HTTP_PORT:-80}:80"
      - "${GITLAB_HTTPS_PORT:-443}:443"
      - "${GITLAB_SSH_PORT:-22}:22"
    restart: ${GITLAB_RESTART:-always}
    networks:
      - frontend

  nodejs:
    build:
      context: nodejs
      args:
        - "NODEJS_VERSION=${NODEJS_VERSION:-latest}"
        - "NODEJS_USER=${NODEJS_USER:-kimhsiao}"
        - "NODEJS_YARN_VERSION=${NODEJS_YARN_VERSION:-latest}"
    environment:
      - "NODE_ENV=${NODEJS_ENV:-develop}"
      - "mem_limit=${NODEJS_MEMORY_LIMIT:-512M}"
      - "memswap_limit=${NODEJS_MEMORY_SWAP_LIMIT:-1G}"
    volumes:
      - "${NODEJS_WORKING_DIR}:/home/${NODEJS_USER}/app"
      - "${LOG_DATA_SAVE_PATH}/nodejs:/var/log"
    ports:
      - "${NODEJS_PORT_MAPPING_1:-80}:80"
      - "${NODEJS_PORT_MAPPING_2:-443}:443"
      - "${NODEJS_PORT_MAPPING_3:-3000}:3000"
      - "${NODEJS_PORT_MAPPING_4:-8080}:8080"
    restart: ${NODEJS_RESTART:-always}
    networks:
      - backend
      - frontend

  cratedb:
    image: "library/crate:${CRATEDB_VERSION:-latest}"
    environment:
      - "CRATE_HEAP_SIZE=${CRATEDB_HEAP_SIZE:-1g}"
    volumes:
      - "${DATA_SAVE_PATH}/cratedb:/data"
      - "${LOG_DATA_SAVE_PATH}/cratedb:/var/log"
    ports:
      - "${CRATEDB_HTTP_PORT:-4200}:4200"
      - "${CRATEDB_TRANSPORT_PORT:-4300}:4300"
      - "${CRATEDB_PGSQL_PROTOCOL_PORT:-5432}:5432"
    restart: ${CRATEDB_RESTART:-always}
    networks:
      - backend
      - frontend

  gitea:
    image: "gitea/gitea:${GITEA_VERSION:-latest}"
    environment:
      - "USER_UID=${GITEA_USER_UID:-1000}"
      - "USER_GID=${GITEA_USER_GID:-1000}"
      - "TZ=${TIMEZONE:-UTC}"
    volumes:
      - gitea_data:/data
    ports:
      - "${GITEA_WEB_PORT:-10080}:3000"
      - "${GITEA_SSH_PORT:-10022}:22"
    restart: ${GITEA_RESTART:-always}
    networks:
      - backend
      - frontend

  drone-gitea:
    image: drone/drone:${DRONE_VERSION:-1}
    volumes:
      - "${DRONE_SERVER_GITEA_VOLUME:-./drone/server/gitea}:/data"
    environment:
      - "DRONE_SERVER_HOST=${DRONE_SERVER_GITEA_HOST:-drone-gitea}"
      - "DRONE_SERVER_PROTO=${DRONE_SERVER_GITEA_PROTO:-http}"
      - "DRONE_RPC_SECRET=${DRONE_RPC_GITEA_SECRET}"
      - "DRONE_AGENTS_ENABLED=${DRONE_AGENTS_GITEA_ENABLED:-true}"
      - "DRONE_GITEA_SERVER=${DRONE_GITEA_SERVER:-http://gitea}"
      - "DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}"
      - "DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}"
      - "DRONE_GIT_ALWAYS_AUTH=${DRONE_GITEA_ALWAYS_AUTH:-false}"
      - "DRONE_LOGS_PRETTY=${DRONE_LOGS_PRETTY}"
      - "DRONE_LOGS_COLOR=${DRONE_LOGS_COLOR}"
    ports:
      - "${DRONE_SERVER_GITEA_PORT:-8000}:80"
    restart: "${DRONE_SERVER_RESTART:-always}"
    networks:
      - backend
      - frontend

  drone-gitlab:
    image: drone/drone:${DRONE_VERSION:-1}
    volumes:
      - "${DRONE_SERVER_GITLAB_VOLUME:-./drone/server/gitlab}:/data"
    environment:
      - "DRONE_SERVER_HOST=${DRONE_SERVER_GITLAB_HOST:-drone-gitlab}"
      - "DRONE_SERVER_PROTO=${DRONE_SERVER_GITLAB_PROTO:-http}"
      - "DRONE_RPC_SECRET=${DRONE_RPC_GITLAB_SECRET}"
      - "DRONE_AGENTS_ENABLED=${DRONE_AGENTS_GITLAB_ENABLED:-true}"
      - "DRONE_GITEA_SERVER=${DRONE_GITLAB_SERVER:-http://gitlab}"
      - "DRONE_GITEA_CLIENT_ID=${DRONE_GITLAB_CLIENT_ID}"
      - "DRONE_GITEA_CLIENT_SECRET=${DRONE_GITLAB_CLIENT_SECRET}"
      - "DRONE_GIT_ALWAYS_AUTH=${DRONE_GITLAB_ALWAYS_AUTH:-false}"
      - "DRONE_LOGS_PRETTY=${DRONE_LOGS_PRETTY}"
      - "DRONE_LOGS_COLOR=${DRONE_LOGS_COLOR}"
    ports:
      - "${DRONE_SERVER_GITLAB_PORT:-8000}:80"
    restart: "${DRONE_SERVER_RESTART:-always}"
    networks:
      - backend
      - frontend

  drone-bitbucket:
    image: drone/drone:${DRONE_VERSION:-1}
    volumes:
      - "${DRONE_SERVER_BITBUCKET_VOLUME:-./drone/server/bitbucket}:/data"
    environment:
      - "DRONE_SERVER_HOST=${DRONE_SERVER_BITBUCKET_HOST:-drone-bitbucket}"
      - "DRONE_SERVER_PROTO=${DRONE_SERVER_BITBUCKET_PROTO:-http}"
      - "DRONE_RPC_SECRET=${DRONE_RPC_BITBUCKET_SECRET}"
      - "DRONE_GIT_USERNAME=${DRONE_BITBUCKET_USERNAME}"
      - "DRONE_GIT_PASSWORD=${DRONE_BITBUCKET_PASSWORD}"
      - "DRONE_GIT_ALWAYS_AUTH=${DRONE_BITBUCKET_ALWAYS_AUTH}"
      - "DRONE_STASH_CONSUMER_KEY=${DRONE_BITBUCKET_CONSUMER_KEY}"
      - "DRONE_STASH_PRIVATE_KEY=${DRONE_BITBUCKET_PRIVATE_KEY}"
      - "DRONE_STASH_SERVER=${DRONE_BITBUCKET_SERVER}"
      - "DRONE_LOGS_PRETTY=${DRONE_LOGS_PRETTY}"
      - "DRONE_LOGS_COLOR=${DRONE_LOGS_COLOR}"
    ports:
      - "${DRONE_SERVER_BITBUCKET_PORT:-8000}:80"
    restart: "${DRONE_SERVER_RESTART:-always}"
    networks:
      - backend
      - frontend

  drone-github:
    image: drone/drone:${DRONE_VERSION:-1}
    volumes:
      - "${DRONE_SERVER_GITHUB_VOLUME:-./drone/server/github}:/data"
    environment:
      - "DRONE_SERVER_HOST=${DRONE_SERVER_GITLAB_HOST:-drone-gitlab}"
      - "DRONE_SERVER_PROTO=${DRONE_SERVER_GITLAB_PROTO:-http}"
      - "DRONE_RPC_SECRET=${DRONE_RPC_GITLAB_SECRET}"
      - "DRONE_GITHUB_CLIENT_ID=${DRONE_GITHUB_CLIENT_ID}"
      - "DRONE_GITHUB_CLIENT_SECRET=${DRONE_GITHUB_CLIENT_SECRET}"
      - "DRONE_LOGS_PRETTY=${DRONE_LOGS_PRETTY}"
      - "DRONE_LOGS_COLOR=${DRONE_LOGS_COLOR}"
    ports:
      - "${DRONE_SERVER_GITHUB_PORT:-8000}:80"
    restart: "${DRONE_SERVER_RESTART:-always}"
    networks:
      - backend
      - frontend

  drone-agent:
    image: drone/agent:${DRONE_VERSION:-1}
    volumes:
      - /var/run/docker.sock:/var/run/docker:sock
    environment:
      - DRONE_RPC_SERVER=${DRONE_RPC_AGENT_SERVER}
      - DRONE_RPC_SECRET=${DRONE_RPC_AGENT_SECRET}
      - DRONE_RUNNER_CAPACITY=${DRONE_RUNNER_CAPACITY:-2}
    restart: "${DRONE_AGENT_RETART:-always}"
    networks:
      - backend

  mosquitto:
    build:
      context: ./mosquitto
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MOSQUITTO_VERSION=${MOSQUITTO_VERSION:-latest}"
    volumes:
      - "${DATA_SAVE_PATH}/mosquitto:/mosquitto/data"
      - "${LOG_DATA_SAVE_PATH}/mosquitto:/mosquitto/log"
      - "./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro"
    ports:
      - "${MOSQUITTO_UNENCRYPTED_PORT:-1883}:1883"
      - "${MOSQUITTO_ENCRYPTED_PORT:-8883}:8883"
      - "${MOSQUITTO_ENCRYPTED_CLIENT_CERT_PORT:-8884}:8884"
      - "${MOSQUITTO_UNENCRYPTED_WEBSOCKET_PORT:-8080}:8080"
      - "${MOSQUITTO_ENCRYPTED_WEBSOCKET_PORT:-8081}:8081"
    restart: ${MOSQUITTO_RESTART:-always}
    networks:
      - backend
      - frontend

  mailhog:
    build:
      context: ./mailhog
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "MAILHOG_VERSION=${MAILHOG_VERSION:-latest}"
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_WEB_PORT:-8025}:8025"
    restart: ${MAILHOG_RESTART:-always}
    networks:
      - backend
      - frontend

  grafana:
    build:
      context: ./grafana
      args:
        - "TZ=${TIMEZONE:-UTC}"
        - "GRAFANA_VERSION=${GRAFANA_VERSION:-latest}"
        - "GF_INSTALL_IMAGE_RENDERER_PLUGIN=${GRAFANA_PLUGINS_INSTALL:-true}"
    environment:
      - "GF_INSTALL_PLUGINS=${GRAFANA_PLUGINS}"
      - "GF_RENDERING_SERVER_URL=${GRAFANA_RENDERING_SERVER_URL}"
      - "GF_RENDERING_CALLBACK_URL=${GRAFANA_RENDERING_CALLBACK_URL}"
      - "GF_LOG_FILTERS=${GRAFANA_LOG_FILTER}"
    volumes:
      - "${DATA_SAVE_PATH}/grafana:/var/lib/grafana"
      - "./grafana/config/grafana.ini:/etc/grafana/grafana.ini:ro"
    ports:
      - "${GRAFANA_EXTERNAL_PORT:-3000}:3000"
    restart: ${GRAFANA_RESTART:-always}
    networks:
      - backend
      - frontend

  grafana-render:
    image: grafana/grafana-image-renderer:latest
    environment:
      - "ENABLE_METRICS=${GRAFANA_RENDER_METRICS:-true}"
      - "BROWSER_TZ=${TIMEZONE:-UTC}"
      - "IGNORE_HTTPS_ERRORS=${GRAFANA_RENDER_IGNORE_HTTPS_ERRORS:-true}"
      - "LOG_LEVEL=${GRAFANA_RENDER_LOG_LEVEL:-debug}"
      - "RENDERING_VERBOSE_LOGGING=${GRAFANA_RENDER_VERBOSE_LOGGING:-true}"
      - "RENDERING_DUMPIO=${GRAFANA_RENDER_DUMPIO:-true}"
      - "RENDERING_ARGS=${GRAFANA_RENDER_ARGS}"
      - "RENDERING_MODE=${GRAFANA_RENDER_MODE:-default}"
    ports:
      - "${GRAFANA_RENDER_PORT:-8081}:8081"
    depends_on:
      - grafana
    restart: ${GRAFANA_RENDER_RESTART:-always}
    networks:
      - frontend

  zookeeper:
    image: zookeeper:${ZOOKEEPER_VERSION:-latest}
    environment:
      - "ZOO_TICK_TIME=${ZOO_TICK_TIME:-2000}"
      - "ZOO_INIT_LIMIT=${ZOO_INIT_LIMIT:-2}"
      - "ZOO_MAX_CLIENT_CNXNS=${ZOO_MAX_CLIENT_CNXNS:-60}"
      - "ZOO_STANDALONE_ENABLED=${ZOO_STANDALONE_ENABLED:-true}"
      - "ZOO_ADMINSERVER_ENABLED=${ZOO_ADMINSERVER_ENABLED:-true}"
      - "ZOO_AUTOPURGE_PURGEINTERVAL=${ZOO_AUTOPURGE_PURGEINTERVAL:-0}"
      - "ZOO_AUTOPURGE_SNAPRETAINCOUNT=${ZOO_AUTOPURGE_SNAPRETAINCOUNT:-3}"
      - "ZOO_4LW_COMMANDS_WHITELIST=${ZOO_4LW_COMMANDS_WHITELIST:-srvr}"
      - "ZOO_CFG_EXTRA=${ZOO_CFG_EXTRA}"
      - "JVMFLAGS=${ZOO_JVMFLAGS}"
    volumes:
      - "${DATA_SAVE_PATH}/zookeeper/conf:/conf"
      - "${DATA_SAVE_PATH}/zookeeper/data:/data"
      - "${DATA_SAVE_PATH}/zookeeper/datalog:/datalog"
    ports:
      - "${ZOO_EXT_CLIENT_PORT:-2181}:2181"
      - "${ZOO_EXT_FOLLOWER_PORT:-2888}:2888"
      - "${ZOO_EXT_ELECTION_PORT:-3888}:3888"
      - "${ZOO_EXT_ADMIN_SERVER_PORT:-8080}:8080"
    restart: ${ZOOKEEP_RESTART:-always}
    networks:
      - backend
      - frontend

  zookeeper-replica-template:
    image: zookeeper:${ZOOKEEPER_VERSION:-latest}
    environment:
      - "ZOO_TICK_TIME=${ZOO_TICK_TIME:-2000}"
      - "ZOO_INIT_LIMIT=${ZOO_INIT_LIMIT:-2}"
      - "ZOO_MAX_CLIENT_CNXNS=${ZOO_MAX_CLIENT_CNXNS:-60}"
      - "ZOO_STANDALONE_ENABLED=${ZOO_STANDALONE_ENABLED:-true}"
      - "ZOO_ADMINSERVER_ENABLED=${ZOO_ADMINSERVER_ENABLED:-true}"
      - "ZOO_AUTOPURGE_PURGEINTERVAL=${ZOO_AUTOPURGE_PURGEINTERVAL:-0}"
      - "ZOO_AUTOPURGE_SNAPRETAINCOUNT=${ZOO_AUTOPURGE_SNAPRETAINCOUNT:-3}"
      - "ZOO_4LW_COMMANDS_WHITELIST=${ZOO_4LW_COMMANDS_WHITELIST:-srvr}"
      - "ZOO_CFG_EXTRA=${ZOO_CFG_EXTRA}"
      - "JVMFLAGS=${ZOO_JVMFLAGS}"
      - "ZOO_MY_ID=${ZOO_MY_ID}"
      - "ZOO_SERVERS=${ZOO_SERVERS}"
    volumes:
      - "${DATA_SAVE_PATH}/zookeeper-replica/conf:/conf"
      - "${DATA_SAVE_PATH}/zookeeper-replica/data:/data"
      - "${DATA_SAVE_PATH}/zookeeper-replica/datalog:/datalog"
    ports:
      - "${ZOO_EXT_CLIENT_PORT:-2181}:2181"
      - "${ZOO_EXT_FOLLOWER_PORT:-2888}:2888"
      - "${ZOO_EXT_ELECTION_PORT:-3888}:3888"
      - "${ZOO_EXT_ADMIN_SERVER_PORT:-8080}:8080"
    restart: ${ZOOKEEP_RESTART:-always}
    networks:
      - backend
      - frontend

  kafka:
    image: wurstmeister/kafka:${KAFKA_DOCERK_VERSION:-latest}
    environment:
      - "KAFKA_ADVERTISED_HOST_NAME=${KAFKA_ADVERTISED_HOST_NAME}"
      - "KAFKA_ZOOKEEPER_CONNECT=${KAFKA_ZOOKEEPER_CONNECT:-zookeeper:2181}"
    volumes:
      - "${DATA_SAVE_PATH}/kafka/config:/opt/kafka/config"
      - "${DATA_SAVE_PATH}/kafka/data:/var/lib/kafka/data"
      - "${DATA_SAVE_PATH}/kafka/secrets:/etc/kafka/secrets"
      - "${LOG_DATA_SAVE_PATH}/kafka:/opt/kafka/logs"
      - "/var/run/docker.sock:/var/run/docker.sock"
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    depends_on:
      - zookeeper
    restart: ${KAFKA_RESTART:-always}
    networks:
      - backend
      - frontend

  wekan:
    image: wekanteam/wekan:${WEKAN_DOCKER_VERSION:-latest}
    environment:
      - "ROOT_URL=${WEKAN_ROOT_URL:-http://localhost}"
      - "MONGO_URL=${WEKAN_MONGO_URL:-mongodb://mongo}"
    ports:
      - "${WEKAN_PORT:-8080}:8080"
    restart: ${WEKAN_RESTART:-always}
    networks:
      - frontend
      - backend

volumes:
  postgres_data:
    driver: local
  postgis_data:
    driver: local
  mysql_data:
    driver: local
  gitea_data:
    driver: local

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
